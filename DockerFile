# --- Base image ---
FROM node:22

# --- Set working directory ---
WORKDIR /app

# --- Copy dependencies and install ---
COPY package*.json ./
RUN npm install

# --- Copy all source code ---
COPY . .

# --- Generate Prisma Client (if using Prisma) ---
RUN npx prisma generate || echo "Skipping prisma generate..."

# --- Expose your server port ---
EXPOSE 4000


# Use nginx to serve built assets
FROM nginx:alpine
COPY --from=builder /app/dist/public /usr/share/nginx/html
EXPOSE 80
# --- Install additional dependencies ---
RUN npm install -g tsx cross-env
# --- Build the application ---
RUN npm run build
# --- Set environment variables ---
ENV NODE_ENV=production
ENV PORT=4000

# --- Start server ---
CMD ["npx", "cross-env", "NODE_ENV=production", "tsx", "server/index.ts"]
